import ssd1306
import framebuf
import time
import _thread
import network
import socket
import time
import sys
import machine
import ubinascii

# Modificar estas variables para cada jugador
PLAYER = 'JavaScript'
HOST = '192.168.1.10'



INITIAL_SLEEP = 10
ENERGY = 100
NPINS = (
    34,
    35,
    32
)
PATH = '/write?db=pylaser'
PORT = 8086

# Nombre de red y password
WIFI_SSID = 'toniToni'
WIFI_PWD = 'cocoloco'

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        wlan.connect(WIFI_SSID, WIFI_PWD)
        while not wlan.isconnected():
            pass
        print("Connected to the WLAN")
    else:
        print('Already connected to WLAN')


def send_hit(energy, player, path, host, port):
    payload = f"energy,player={player} value={energy}"
    data = f'POST {path} HTTP/1.1\r\nHost: {host}:{port}\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: {len(payload)}\r\n\r\n{payload}'
    addr = socket.getaddrinfo(host, port)[0][-1]
    print("Sending request...")
    try:
        s = socket.socket()
        s.connect(addr)
        s.send(bytes(data, 'utf8'))
    except:
        print("Failed sending request :(")
    finally:
        s.close()
        print("Socket closed.")


def energy_update():
    global ENERGY, PLAYER, PATH, HOST, PORT
    while True:
        send_hit(ENERGY, PLAYER, PATH, HOST, PORT)
        time.sleep(2)

def main():
    global ENERGY, PLAYER, PATH, HOST, PORT, INITIAL_SLEEP
    time.sleep(INITIAL_SLEEP)
    print("Starting player...")
    while True:

        hit = 0
        for npin in NPINS:
            pin = machine.Pin(npin, machine.Pin.IN)
            if not pin.value():
                hit += 1

        if hit:
            ENERGY -= hit
            print('HIT!')
            print(f"Energy: {ENERGY}")

        if ENERGY <= 0:
            print('Die!!!')
            sys.exit()
        time.sleep(0.1)


def show_skull(display):
    display.framebuf.fill(0)
    img_skull = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf8\x00\x00\x00\x00\x07\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x03\xfc\x00\x00\x00\x00\x0f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x07\xfe\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xe0\x00\x00\x01\xff\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x01\xff\xf0\x00\x00\x01\xff\xf0\x00\x00\x01\xff\xff\xf0\x00\x00\x00\xff\xf8\x00\x00\x00\xff\xfc\x00\x00\x0f\xff\xff\xff\x00\x00\x03\xff\xf0\x00\x00\x00\x3e\x3f\x00\x00\x67\xff\xff\xfc\xe0\x00\x0f\xc7\xc0\x00\x00\x00\x00\x1f\x00\x03\xdf\xff\xff\xff\xbc\x00\x0f\x80\x00\x00\x00\x00\x00\x0f\xc0\x0f\x5f\xff\xff\xff\xaf\x00\x7f\x00\x00\x00\x00\x00\x00\x03\xf0\x1d\xbf\xff\xff\xff\xd3\x80\xfc\x00\x00\x00\x00\x00\x00\x00\xf8\x7f\xff\xff\xff\xff\xff\xe1\xf0\x00\x00\x00\x00\x00\x00\x00\xfc\xff\xff\xff\xff\xff\xff\xf7\xe0\x00\x00\x00\x00\x00\x00\x00\x3c\x00\x00\x00\x00\x00\x00\x07\x80\x00\x00\x00\x00\x00\x00\x00\x1b\xff\xff\xff\xff\xff\xff\xf9\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\xff\xff\xff\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\xff\xff\xff\xff\xff\xff\xff\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xff\xff\xff\xff\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xf0\x3f\xff\xc1\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xc0\x0f\xff\x00\x3f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\x80\x07\xfc\x00\x1f\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\x80\x07\xfc\x00\x1f\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x80\x07\xfe\x00\x1f\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xc0\x0f\xff\x00\x3f\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xf8\x7f\xff\xe1\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\x0f\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xff\xfc\x03\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\xf8\x03\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\xfc\x07\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x8f\xff\x0f\xff\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x7e\x1f\xff\x87\xec\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x7f\xc0\x00\x3f\xee\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1e\x0f\xdf\x9f\xbf\x0f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\xff\x3f\x9f\xcf\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7d\xff\x00\x00\x0f\xf3\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf8\xe6\xff\x9f\xf6\xf1\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe1\xfc\xff\x9f\xf3\xf8\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x81\xff\xe0\x00\x7f\xf8\x1f\x00\x00\x00\x00\x00\x00\x00\x1f\x1f\x80\xff\xff\xff\xff\xf0\x1f\x8f\x80\x00\x00\x00\x00\x00\xff\xfe\x00\x7f\xff\xff\xff\xe0\x07\xff\xe0\x00\x00\x00\x00\x00\xff\xf8\x00\x7f\xff\xff\xff\xe0\x01\xff\xf0\x00\x00\x00\x00\x00\xff\xfc\x00\x1f\xff\xff\xff\x80\x07\xff\xe0\x00\x00\x00\x00\x00\x3f\xff\x00\x07\xff\xff\xfe\x00\x0f\xff\xc0\x00\x00\x00\x00\x00\x07\xff\x00\x01\xff\xff\xf8\x00\x0f\xfc\x00\x00\x00\x00\x00\x00\x03\xfe\x00\x00\x0f\xff\x00\x00\x07\xfc\x00\x00\x00\x00\x00\x00\x00\xf8\x00\x00\x00\x00\x00\x00\x01\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')

    fb = framebuf.FrameBuffer(img_skull, 127, 63, framebuf.MONO_HLSB)
    display.framebuf.blit(fb, 0, 0)
    display.show()


def display():
    global ENERGY, INITIAL_SLEEP, PLAYER
    HEIGHT = 63

    i2c = machine.SoftI2C(sda=machine.Pin(21), scl=machine.Pin(22))
    display = ssd1306.SSD1306_I2C(127, HEIGHT, i2c)

    display.framebuf.fill(0)
    display.framebuf.text("Yo amo", 15, 15, 255)
    display.framebuf.text(PLAYER, 25, 35, 255)
    display.show()
    time.sleep(INITIAL_SLEEP)

    display.framebuf.fill(255)
    while True:
        # for i in range(100 - ENERGY + 7, 100 + 7):
        # for i in range(0, ENERGY):
        #     display.framebuf.vline(i, 0, HEIGHT, 255)
        for i in range(ENERGY, 127):
            display.framebuf.vline(i, 0, HEIGHT, 0)
        display.show()

        if ENERGY <= 0:
            show_skull(display)
            break
        time.sleep(0.1)


connect_wifi()
_thread.start_new_thread(main, [])
_thread.start_new_thread(energy_update, [])
_thread.start_new_thread(display, [])
